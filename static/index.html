<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老師預約系統</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2C1810;
            --accent: #D4704A;
            --secondary: #8B6B47;
            --background: #FAF8F5;
            --card-bg: #FFFFFF;
            --text: #1A1A1A;
            --text-light: #6B6B6B;
            --border: #E8E3DB;
            --success: #4A8B6B;
            --success-bg: #F0F7F4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
        }

        header {
            padding: 60px 0 50px;
            border-bottom: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 40px;
        }

        .header-subtitle {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header-left h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 56px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 12px;
        }

        .header-desc {
            font-size: 17px;
            color: var(--text-light);
            max-width: 500px;
            line-height: 1.7;
            margin-top: 16px;
        }

        .info-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 30px;
            min-width: 260px;
        }

        .info-card .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .info-card .value {
            font-size: 15px;
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 18px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            background: var(--success-bg);
            padding: 4px 10px;
            border-radius: 2px;
            font-weight: 500;
        }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .main-content {
            padding: 60px 0 100px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 60px;
            align-items: start;
        }

        .section-title {
            font-family: 'Crimson Pro', serif;
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .section-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .teachers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 50px;
        }

        .teacher-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .teacher-card:hover {
            border-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(44, 24, 16, 0.06);
        }

        .teacher-card.selected {
            border-color: var(--accent);
            background: rgba(212, 112, 74, 0.03);
        }

        .teacher-card.selected::after {
            content: 'SELECTED';
            position: absolute;
            top: 12px; right: 12px;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            letter-spacing: 0.08em;
        }

        .teacher-info {
            padding: 24px;
            position: relative;
        }

        .teacher-name {
            font-family: 'Crimson Pro', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .teacher-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .teacher-specialty {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .teacher-rate {
            font-family: 'Crimson Pro', serif;
            font-size: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        .calendar-section {
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .current-month {
            font-family: 'Crimson Pro', serif;
            font-size: 22px;
            color: var(--primary);
            font-weight: 600;
        }

        .nav-btn {
            background: none;
            border: 1px solid var(--border);
            width: 36px; height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary);
        }

        .nav-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text);
        }

        .calendar-day:hover:not(.disabled):not(.other-month) {
            border-color: var(--border);
            background: var(--card-bg);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.today {
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 600;
        }

        .calendar-day.disabled,
        .calendar-day.other-month {
            color: var(--border);
            cursor: default;
        }

        .time-slots-section {
            margin-bottom: 50px;
        }

        .time-period {
            margin-bottom: 24px;
        }

        .time-period-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .time-slot {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--primary);
            background: var(--card-bg);
        }

        .time-slot:hover:not(.booked) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .time-slot.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .time-slot.booked {
            background: var(--background);
            color: var(--border);
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary);
            letter-spacing: 0.03em;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px 14px;
            border: 1px solid var(--border);
            font-family: 'Work Sans', sans-serif;
            font-size: 14px;
            color: var(--text);
            background: var(--card-bg);
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--accent);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .sidebar {
            position: sticky;
            top: 30px;
        }

        .summary-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 35px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-family: 'Crimson Pro', serif;
            font-size: 24px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
            gap: 12px;
        }

        .summary-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-light);
            font-weight: 600;
        }

        .summary-value {
            font-size: 14px;
            color: var(--primary);
            font-weight: 500;
            text-align: right;
        }

        .summary-value.empty {
            color: var(--border);
            font-style: italic;
            font-weight: 400;
        }

        .summary-divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-total .label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-light);
            font-weight: 600;
        }

        .summary-total .price {
            font-family: 'Crimson Pro', serif;
            font-size: 28px;
            color: var(--primary);
            font-weight: 700;
        }

        .book-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: var(--background);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Work Sans', sans-serif;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .book-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(44, 24, 16, 0.15);
        }

        .notes-card {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 20px 24px;
        }

        .notes-card h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .notes-card ul {
            list-style: none;
        }

        .notes-card ul li {
            font-size: 13px;
            color: var(--text-light);
            padding: 5px 0;
            padding-left: 14px;
            position: relative;
            line-height: 1.5;
        }

        .notes-card ul li::before {
            content: '–';
            position: absolute;
            left: 0;
            color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 60px 50px;
            max-width: 520px;
            width: 90%;
            text-align: center;
        }

        .confirm-icon {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: var(--success-bg);
            border: 2px solid #C8E3D8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 28px;
            font-family: 'Crimson Pro', serif;
            color: var(--success);
            font-weight: 700;
        }

        .modal-content h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .modal-content p {
            color: var(--text-light);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 30px;
        }

        .confirm-details {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 20px 24px;
            text-align: left;
            margin-bottom: 30px;
        }

        .confirm-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .confirm-detail-item:last-child {
            border-bottom: none;
        }

        .confirm-detail-item .key {
            color: var(--text-light);
        }

        .confirm-detail-item .val {
            color: var(--primary);
            font-weight: 500;
        }

        .confirm-btn {
            padding: 14px 40px;
            background: var(--primary);
            color: var(--background);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Work Sans', sans-serif;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .confirm-btn:hover {
            background: var(--accent);
        }

        footer {
            padding: 40px 0;
            border-top: 1px solid var(--border);
            color: var(--text-light);
            font-size: 13px;
            text-align: center;
        }

        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
            .sidebar { position: static; }
            .header-top { flex-direction: column; }
            .teachers-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 600px) {
            .container { padding: 0 20px; }
            .header-left h1 { font-size: 40px; }
            .time-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="header-top">
            <div class="header-left">
                <div class="header-subtitle">專業教學 · 預約系統</div>
                <h1>老師課程<br>線上預約</h1>
                <p class="header-desc">
                    專業師資即時預約，彈性時段選擇，
                    支援 LINE 智慧客服自動預約。
                </p>
            </div>
            <div class="info-card">
                <div class="label">服務時間</div>
                <div class="value">每日 09:00 – 21:00</div>
                <div class="label">預約方式</div>
                <div class="value">網頁 · LINE AI</div>
                <div class="label">當前狀態</div>
                <div class="value">
                    <span class="status-badge">
                        <span class="status-dot"></span>開放預約中
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <div class="main-content">
        <div class="left-panel">
            
            <div class="section-block">
                <h2 class="section-title">選擇老師</h2>
                <p class="section-subtitle">請選擇您想預約的專業老師</p>

                <div class="teachers-grid" id="teachersGrid">
                    <!-- 動態載入 -->
                </div>
            </div>

            <div class="section-block" id="dateSection" style="display:none;">
                <h2 class="section-title">選擇日期</h2>
                <p class="section-subtitle">請選擇您想預約的日期</p>

                <div class="calendar-section">
                    <div class="calendar-header">
                        <div style="display:flex;align-items:center;gap:20px;">
                            <button class="nav-btn" onclick="changeMonth(-1)">‹</button>
                            <div class="current-month" id="currentMonth"></div>
                            <button class="nav-btn" onclick="changeMonth(1)">›</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div class="section-block" id="timeSection" style="display:none;">
                <h2 class="section-title">選擇時段</h2>
                <p class="section-subtitle" id="selectedDateLabel"></p>

                <div class="time-slots-section">
                    <div class="time-period">
                        <div class="time-period-label">上午 Morning</div>
                        <div class="time-grid" id="morningSlots"></div>
                    </div>
                    <div class="time-period">
                        <div class="time-period-label">下午 Afternoon</div>
                        <div class="time-grid" id="afternoonSlots"></div>
                    </div>
                    <div class="time-period">
                        <div class="time-period-label">晚間 Evening</div>
                        <div class="time-grid" id="eveningSlots"></div>
                    </div>
                </div>
            </div>

            <div class="section-block" id="formSection" style="display:none;">
                <h2 class="section-title">聯絡資料</h2>
                <p class="section-subtitle">請填寫您的聯絡資訊</p>

                <div class="form-row">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" id="customerName" placeholder="請輸入姓名" oninput="updateSummary()">
                    </div>
                    <div class="form-group">
                        <label>手機號碼</label>
                        <input type="tel" id="customerPhone" placeholder="0912-345-678" oninput="updateSummary()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full">
                        <label>備註</label>
                        <textarea id="note" placeholder="有任何特殊需求嗎？（選填）"></textarea>
                    </div>
                </div>
            </div>

        </div>

        <div class="sidebar">
            <div class="summary-card">
                <div class="summary-title">預約摘要</div>

                <div class="summary-item">
                    <div class="summary-label">老師</div>
                    <div class="summary-value empty" id="sum-teacher">請選擇老師</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">日期</div>
                    <div class="summary-value empty" id="sum-date">請選擇日期</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">時間</div>
                    <div class="summary-value empty" id="sum-time">請選擇時間</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">課程時長</div>
                    <div class="summary-value empty" id="sum-duration">60 分鐘</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">姓名</div>
                    <div class="summary-value empty" id="sum-name">請填寫資料</div>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-total">
                    <div class="label">費用</div>
                    <div class="price" id="sum-price">NT$ 0</div>
                </div>
            </div>

            <button class="book-btn" onclick="submitBooking()">確認預約</button>

            <div style="height:20px;"></div>

            <div class="notes-card">
                <h4>注意事項</h4>
                <ul>
                    <li>請提前 10 分鐘到場準備</li>
                    <li>取消或更改請提前 24 小時通知</li>
                    <li>課程時長為 60 分鐘</li>
                    <li>請攜帶相關學習資料</li>
                    <li>遲到超過 15 分鐘視同放棄</li>
                    <li>可透過 LINE 聯繫老師</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        © 2026 老師預約系統 · 支援 LINE 智慧預約
    </div>
</footer>

<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="confirm-icon">OK</div>
        <h2>預約成功！</h2>
        <p>您的課程預約已確認<br>預約編號將以簡訊傳送至您的手機</p>
        <div class="confirm-details" id="confirmDetails"></div>
        <button class="confirm-btn" onclick="closeConfirm()">完成</button>
    </div>
</div>

<script>
const API = '';
const state = {
    teacher: null,
    teacherId: null,
    teacherRate: 0,
    date: null,
    time: null,
    duration: 60,
    price: 0,
    name: '',
    phone: ''
};

let teachers = [];
let currentDate = new Date();
let availableTimes = [];
let bookedTimes = [];

const months = ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'];
const days = ['日','一','二','三','四','五','六'];

// Load teachers
async function loadTeachers() {
    try {
        const res = await fetch(`${API}/api/teachers`);
        teachers = await res.json();
        renderTeachers();
    } catch (e) {
        console.error('載入老師失敗', e);
    }
}

function renderTeachers() {
    const grid = document.getElementById('teachersGrid');
    grid.innerHTML = teachers.map(t => `
        <div class="teacher-card" onclick="selectTeacher(${t.id}, '${t.name}', ${t.hourly_rate})">
            <div class="teacher-info">
                <div class="teacher-name">${t.name}</div>
                <div class="teacher-title">${t.title || '專業講師'}</div>
                <div class="teacher-specialty">${t.specialty || ''}</div>
                <div class="teacher-rate">NT$ ${t.hourly_rate} / 小時</div>
            </div>
        </div>
    `).join('');
}

function selectTeacher(id, name, rate) {
    state.teacherId = id;
    state.teacher = name;
    state.teacherRate = rate;
    
    document.querySelectorAll('.teacher-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    document.getElementById('sum-teacher').textContent = name;
    document.getElementById('sum-teacher').classList.remove('empty');
    
    document.getElementById('dateSection').style.display = 'block';
    updatePrice();
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    document.getElementById('currentMonth').textContent = `${year} 年 ${months[month]}`;
    
    const grid = document.getElementById('calendarGrid');
    const today = new Date();
    let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const prevDays = new Date(year, month, 0).getDate();
    
    for (let i = firstDay - 1; i >= 0; i--)
        html += `<div class="calendar-day other-month">${prevDays - i}</div>`;
    
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const isToday = date.toDateString() === today.toDateString();
        const isPast = date < today && !isToday;
        const classes = ['calendar-day', isToday?'today':'', isPast?'disabled':''].filter(Boolean).join(' ');
        const onclick = !isPast ? `onclick="selectDate(${year},${month},${d})"` : '';
        html += `<div class="${classes}" ${onclick}>${d}</div>`;
    }
    
    const rem = (7 - (firstDay + daysInMonth) % 7) % 7;
    for (let d = 1; d <= rem; d++)
        html += `<div class="calendar-day other-month">${d}</div>`;
    
    grid.innerHTML = html;
}

function changeMonth(dir) {
    currentDate.setMonth(currentDate.getMonth() + dir);
    renderCalendar();
}

async function selectDate(year, month, day) {
    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    const d = new Date(year, month, day);
    state.date = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const weekdays = ['日','一','二','三','四','五','六'];
    
    document.getElementById('sum-date').textContent = state.date + ' 週' + weekdays[d.getDay()];
    document.getElementById('sum-date').classList.remove('empty');
    document.getElementById('selectedDateLabel').textContent = `${state.date} 週${weekdays[d.getDay()]} 可預約時段`;
    
    // Load available times
    await loadAvailableTimes();
    
    document.getElementById('timeSection').style.display = 'block';
    document.getElementById('formSection').style.display = 'block';
}

async function loadAvailableTimes() {
    try {
        const res = await fetch(`${API}/api/teachers/${state.teacherId}/availability?date=${state.date}`);
        const data = await res.json();
        
        availableTimes = data.available_times;
        bookedTimes = data.booked_times;
        
        renderTimeSlots();
    } catch (e) {
        console.error('載入可用時段失敗', e);
    }
}

function renderTimeSlots() {
    const morning = availableTimes.filter(t => parseInt(t.split(':')[0]) < 12);
    const afternoon = availableTimes.filter(t => {
        const h = parseInt(t.split(':')[0]);
        return h >= 12 && h < 18;
    });
    const evening = availableTimes.filter(t => parseInt(t.split(':')[0]) >= 18);
    
    document.getElementById('morningSlots').innerHTML = morning.map(t => 
        `<div class="time-slot" onclick="selectTime('${t}')">${t}</div>`
    ).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--text-light);">無可用時段</div>';
    
    document.getElementById('afternoonSlots').innerHTML = afternoon.map(t => 
        `<div class="time-slot" onclick="selectTime('${t}')">${t}</div>`
    ).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--text-light);">無可用時段</div>';
    
    document.getElementById('eveningSlots').innerHTML = evening.map(t => 
        `<div class="time-slot" onclick="selectTime('${t}')">${t}</div>`
    ).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--text-light);">無可用時段</div>';
}

function selectTime(time) {
    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    state.time = time;
    
    document.getElementById('sum-time').textContent = time;
    document.getElementById('sum-time').classList.remove('empty');
    updatePrice();
}

function updateSummary() {
    const name = document.getElementById('customerName').value;
    const phone = document.getElementById('customerPhone').value;
    if (name) {
        state.name = name;
        state.phone = phone;
        document.getElementById('sum-name').textContent = name + (phone ? ` · ${phone}` : '');
        document.getElementById('sum-name').classList.remove('empty');
    }
}

function updatePrice() {
    if (state.teacherRate) {
        state.price = Math.round((state.duration / 60) * state.teacherRate);
        document.getElementById('sum-price').textContent = 'NT$ ' + state.price.toLocaleString();
    }
}

async function submitBooking() {
    if (!state.teacherId || !state.date || !state.time || !state.name || !state.phone) {
        alert('請完整填寫預約資訊');
        return;
    }
    
    const data = {
        teacher_id: state.teacherId,
        date: state.date,
        time: state.time,
        duration: state.duration,
        name: state.name,
        phone: state.phone,
        note: document.getElementById('note').value
    };
    
    try {
        const res = await fetch(`${API}/api/book`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            const result = await res.json();
            showConfirmation(result.booking);
        } else {
            const error = await res.json();
            alert(error.error || '預約失敗');
        }
    } catch (e) {
        alert('預約失敗：' + e.message);
    }
}

function showConfirmation(booking) {
    const details = [
        ['預約編號', booking.booking_number],
        ['老師', state.teacher],
        ['日期', state.date],
        ['時間', state.time],
        ['課程時長', `${state.duration} 分鐘`],
        ['姓名', state.name],
        ['費用', `NT$ ${state.price.toLocaleString()}`]
    ];
    
    document.getElementById('confirmDetails').innerHTML = details
        .map(([k,v]) => `<div class="confirm-detail-item"><span class="key">${k}</span><span class="val">${v}</span></div>`)
        .join('');
    
    document.getElementById('confirmModal').classList.add('active');
}

function closeConfirm() {
    document.getElementById('confirmModal').classList.remove('active');
    location.reload();
}

document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) closeConfirm();
});

loadTeachers();
renderCalendar();
</script>

</body>
</html>